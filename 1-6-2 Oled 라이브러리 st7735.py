import machine
import time
import ustruct

class ST7735:
    # 8x8 폰트 데이터 (ASCII 32-126 포함)
    _FONT = b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x5f\x00\x00\x00\x00\x00\x00\x07\x00\x07\x00\x00\x00\x00\x14\x7f\x14\x7f\x14\x00\x00\x00\x24\x2a\x7f\x2a\x12\x00\x00\x00\x23\x13\x08\x64\x62\x00\x00\x00\x36\x49\x55\x22\x50\x00\x00\x00\x00\x05\x03\x00\x00\x00\x00\x00\x1c\x22\x41\x00\x00\x00\x00\x00\x41\x22\x1c\x00\x00\x00\x00\x00\x08\x2a\x1c\x2a\x08\x00\x00\x00\x08\x08\x3e\x08\x08\x00\x00\x00\x00\x50\x30\x00\x00\x00\x00\x00\x08\x08\x08\x08\x08\x00\x00\x00\x00\x60\x60\x00\x00\x00\x00\x00\x20\x10\x08\x04\x02\x00\x00\x00\x3e\x51\x49\x45\x3e\x00\x00\x00\x00\x42\x7f\x40\x00\x00\x00\x00\x42\x61\x51\x49\x46\x00\x00\x00\x21\x41\x45\x4b\x31\x00\x00\x00\x18\x14\x12\x7f\x10\x00\x00\x00\x27\x45\x45\x45\x39\x00\x00\x00\x3c\x4a\x49\x49\x30\x00\x00\x00\x01\x71\x09\x05\x03\x00\x00\x00\x36\x49\x49\x49\x36\x00\x00\x00\x06\x49\x49\x29\x1e\x00\x00\x00\x00\x36\x36\x00\x00\x00\x00\x00\x00\x56\x36\x00\x00\x00\x00\x00\x08\x14\x22\x41\x00\x00\x00\x00\x14\x14\x14\x14\x14\x00\x00\x00\x41\x22\x14\x08\x00\x00\x00\x00\x02\x01\x51\x09\x06\x00\x00\x00\x32\x49\x79\x41\x3e\x00\x00\x00\x7e\x11\x11\x11\x7e\x00\x00\x00\x7f\x49\x49\x49\x36\x00\x00\x00\x3e\x41\x41\x41\x22\x00\x00\x00\x7f\x41\x41\x22\x1c\x00\x00\x00\x7f\x49\x49\x49\x41\x00\x00\x00\x7f\x09\x09\x01\x01\x00\x00\x00\x3e\x41\x49\x49\x7a\x00\x00\x00\x7f\x08\x08\x08\x7f\x00\x00\x00\x00\x41\x7f\x41\x00\x00\x00\x00\x20\x40\x41\x3f\x01\x00\x00\x00\x7f\x08\x14\x22\x41\x00\x00\x00\x7f\x40\x40\x40\x40\x00\x00\x00\x7f\x02\x0c\x02\x7f\x00\x00\x00\x7f\x04\x08\x10\x7f\x00\x00\x00\x3e\x41\x41\x41\x3e\x00\x00\x00\x7f\x09\x09\x09\x06\x00\x00\x00\x3e\x41\x51\x21\x5e\x00\x00\x00\x7f\x09\x19\x29\x46\x00\x00\x00\x46\x49\x49\x49\x31\x00\x00\x00\x01\x01\x7f\x01\x01\x00\x00\x00\x3f\x40\x40\x40\x3f\x00\x00\x00\x1f\x20\x40\x20\x1f\x00\x00\x00\x3f\x40\x38\x40\x3f\x00\x00\x00\x63\x14\x08\x14\x63\x00\x00\x00\x07\x08\x70\x08\x07\x00\x00\x00\x61\x51\x49\x45\x43\x00\x00\x00\x00\x7f\x41\x41\x00\x00\x00\x00\x02\x04\x08\x10\x20\x00\x00\x00\x00\x41\x41\x7f\x00\x00\x00\x00\x04\x02\x01\x02\x04\x00\x00\x00\x40\x40\x40\x40\x40\x00\x00\x00\x01\x02\x04\x00\x00\x00\x00\x00\x20\x54\x54\x54\x78\x00\x00\x00\x7f\x48\x44\x44\x38\x00\x00\x00\x38\x44\x44\x44\x20\x00\x00\x00\x38\x44\x44\x48\x7f\x00\x00\x00\x38\x54\x54\x54\x18\x00\x00\x00\x08\x7e\x09\x01\x02\x00\x00\x00\x0c\x52\x52\x52\x3e\x00\x00\x00\x7f\x08\x04\x04\x78\x00\x00\x00\x00\x44\x7d\x40\x00\x00\x00\x00\x20\x40\x44\x3d\x00\x00\x00\x00\x7f\x10\x28\x44\x00\x00\x00\x00\x00\x41\x7f\x40\x00\x00\x00\x00\x7c\x04\x18\x04\x78\x00\x00\x00\x7c\x08\x04\x04\x78\x00\x00\x00\x38\x44\x44\x44\x38\x00\x00\x00\x7c\x14\x14\x14\x08\x00\x00\x00\x08\x14\x14\x18\x7c\x00\x00\x00\x7c\x08\x04\x04\x08\x00\x00\x00\x48\x54\x54\x54\x20\x00\x00\x00\x04\x3f\x44\x40\x20\x00\x00\x00\x3c\x40\x40\x20\x7c\x00\x00\x00\x1c\x20\x40\x20\x1c\x00\x00\x00\x3c\x40\x30\x40\x3c\x00\x00\x00\x44\x28\x10\x28\x44\x00\x00\x00\x0c\x50\x50\x50\x3c\x00\x00\x00\x44\x64\x54\x4c\x44\x00\x00\x00'

    def __init__(self, spi, cs, dc, res, width=128, height=160):
        self.spi = spi
        self.cs = cs
        self.dc = dc
        self.res = res
        self.width = width
        self.height = height
        self.cs.init(self.cs.OUT, value=1)
        self.dc.init(self.dc.OUT, value=0)
        self.res.init(self.res.OUT, value=1)
        self.init()

    def write_cmd(self, cmd):
        self.dc.value(0); self.cs.value(0)
        self.spi.write(cmd); self.cs.value(1)

    def write_data(self, data):
        self.dc.value(1); self.cs.value(0)
        self.spi.write(data); self.cs.value(1)

    def init(self):
        self.res.value(0); time.sleep_ms(100); self.res.value(1); time.sleep_ms(100)
        self.write_cmd(b"\x01"); time.sleep_ms(150)
        self.write_cmd(b"\x11"); time.sleep_ms(255)
        self.write_cmd(b"\x3A"); self.write_data(b"\x05")
        self.write_cmd(b"\x36"); self.write_data(b"\xC8") # 위아래 반전
        self.write_cmd(b"\x29")

    def set_window(self, x0, y0, x1, y1):
        self.write_cmd(b"\x2A"); self.write_data(ustruct.pack(">HH", x0, x1))
        self.write_cmd(b"\x2B"); self.write_data(ustruct.pack(">HH", y0, y1))
        self.write_cmd(b"\x2C")

    def fill_rect(self, x, y, w, h, color):
        self.set_window(x, y, x + w - 1, y + h - 1)
        pixel = ustruct.pack(">H", color)
        self.dc.value(1); self.cs.value(0)
        for _ in range(w * h): self.spi.write(pixel)
        self.cs.value(1)

    def fill(self, color):
        self.fill_rect(0, 0, self.width, self.height, color)

    def text(self, x, y, string, color):
        for char in string:
            idx = ord(char) - 32
            if 0 <= idx < 95:
                data = self._FONT[idx*8:idx*8+8]
                for i in range(8):
                    for j in range(8):
                        if (data[i] >> j) & 0x01:
                            self.fill_rect(x + i, y + j, 1, 1, color)
            x += 8
