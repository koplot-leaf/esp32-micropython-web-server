import network, machine, socket, gc, time, dht, neopixel
from machine import Pin, PWM, I2C
import ssd1306

# --- [í•˜ë“œì›¨ì–´ ì„¤ì •] ---
SSID, PASSWORD = 'IOT', '12345678'
NUM_LEDS = 12  # ë„¤ì˜¤í”½ì…€ ê°œìˆ˜ 12ê°œë¡œ ìˆ˜ì •
np = neopixel.NeoPixel(Pin(18), NUM_LEDS)

try:
    i2c = I2C(0, scl=Pin(22), sda=Pin(21))
    oled = ssd1306.SSD1306_I2C(128, 64, i2c)
except: oled = None

dht_sensor = dht.DHT11(Pin(4))
obs_sensor = Pin(13, Pin.IN)
relay = Pin(16, Pin.OUT); relay.value(0)
fan_ina = PWM(Pin(14), freq=1000); fan_ina.duty(0)
fan_inb = Pin(27, Pin.OUT); fan_inb.value(0)

fan_running = False
current_speed = 750
temp, hum = 0, 0
led_mode = "OFF"

def set_led_color(mode):
    global led_mode
    led_mode = mode
    # ìƒ‰ìƒ ê°•ë„ë¥¼ 150 ì •ë„ë¡œ ì„¤ì • (ë„ˆë¬´ ë†’ìœ¼ë©´ ë°œì—´/ì „ë ¥ì†Œëª¨ ì‹¬í•¨)
    color = (150, 150, 150) if mode == "WHITE" else (150, 80, 20) if mode == "WARM" else (0, 0, 0)
    for i in range(NUM_LEDS): np[i] = color
    np.write()

def update_hardware():
    global temp, hum
    try:
        dht_sensor.measure()
        temp, hum = dht_sensor.temperature(), dht_sensor.humidity()
    except: pass
    
    if oled:
        oled.fill(0)
        oled.text("SMART TOILET", 15, 0)
        oled.text(f"T:{temp}C H:{hum}%", 0, 25)
        st = "OCCUPIED" if obs_sensor.value() == 0 else "VACANT"
        oled.text(f"STAT: {st}", 0, 40)
        # íŒ¬ í˜„ì¬ ì†ë„ OLED í‘œì‹œ
        f_val = current_speed if fan_running else 0
        oled.text(f"FAN: {f_val}", 0, 55)
        oled.show()

# --- [ì›¹ UI ë””ìì¸] ---
def web_page():
    is_occ = (obs_sensor.value() == 0)
    occ_text, occ_color = ("ì‚¬ìš© ì¤‘", "#FF4757") if is_occ else ("ë¹„ì–´ ìˆìŒ", "#2ED573")
    f_on = "background:#2c3e50;color:white;" if fan_running else "background:#eee;color:#aaa;"
    f_off = "background:#e74c3c;color:white;" if not fan_running else "background:#eee;color:#aaa;"
    display_speed = current_speed if fan_running else 0
    
    return f"""<!DOCTYPE html><html><head><meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width,initial-scale=1'>
    <style>
        body {{ font-family:sans-serif; background:#f4f7f6; display:flex; flex-direction:column; align-items:center; padding:20px; }}
        .card {{ background:white; width:95%; max-width:380px; padding:20px; border-radius:25px; margin-bottom:15px; box-shadow:0 8px 20px rgba(0,0,0,0.05); text-align:center; }}
        .status {{ padding:15px; border-radius:15px; border:2px solid {occ_color}; color:{occ_color}; font-weight:bold; font-size:20px; }}
        .speed-text {{ font-size:50px; font-weight:100; color:#333; margin:10px 0; }}
        .btn-group {{ display:flex; gap:10px; margin-bottom:10px; }}
        .btn {{ flex:1; padding:15px; border:none; border-radius:12px; cursor:pointer; font-weight:bold; text-decoration:none; display:inline-block; font-size:14px; }}
        .btn-white {{ background:#fff; border:1px solid #ddd; color:#333; }}
        .btn-warm {{ background:#f39c12; color:white; }}
    </style></head><body>
    <div class='card'><h2>ğŸš½ í™”ì¥ì‹¤ ìƒíƒœ</h2><div class='status'>{occ_text}</div><p>{temp}â„ƒ / {hum}%</p></div>
    <div class='card'><h2>ğŸ’¡ ì¡°ëª… ì œì–´</h2>
        <div class='btn-group'>
            <a href='/?led=WHITE' class='btn btn-white'>í°ìƒ‰</a>
            <a href='/?led=WARM' class='btn btn-warm'>í™©í† ìƒ‰</a>
            <a href='/?led=OFF' class='btn' style='background:#333;color:white;'>ë„ê¸°</a>
        </div>
    </div>
    <div class='card'><h2>ğŸŒ€ íŒ¬ ì œì–´ (0-1023)</h2>
        <div class='speed-text'>{display_speed}</div>
        <div class='btn-group'>
            <a href='/?p=1' class='btn' style='{f_on}'>FAN ON</a>
            <a href='/?p=0' class='btn' style='{f_off}'>FAN OFF</a>
        </div>
        <form action='/'><input type='range' name='s' min='0' max='1023' value='{current_speed}' style='width:100%;' onchange='this.form.submit()'></form>
    </div>
    <script>setTimeout(function(){{ location.reload(); }}, 4000);</script>
    </body></html>"""

# --- [ì„œë²„ ê°€ë™] ---
wlan = network.WLAN(network.STA_IF); wlan.active(True); wlan.connect(SSID, PASSWORD)
while not wlan.isconnected(): time.sleep(0.5)
ip = wlan.ifconfig()[0]

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.bind(('', 80)); s.listen(1)
print("Connected! IP:", ip)

while True:
    try:
        update_hardware()
        s.settimeout(0.3)
        try:
            conn, addr = s.accept()
            raw_req = conn.recv(1024).decode()
            if not raw_req: 
                conn.close()
                continue

            if 'led=WHITE' in raw_req: set_led_color("WHITE")
            elif 'led=WARM' in raw_req: set_led_color("WARM")
            elif 'led=OFF' in raw_req: set_led_color("OFF")
            
            if 'p=1' in raw_req: 
                relay.value(1); fan_inb.value(0); fan_ina.duty(current_speed); fan_running = True
            elif 'p=0' in raw_req:
                relay.value(0); fan_ina.duty(0); fan_running = False
            
            if 's=' in raw_req:
                try:
                    start = raw_req.find('s=') + 2
                    end = raw_req.find(' ', start)
                    current_speed = int(raw_req[start:end])
                    if fan_running: fan_ina.duty(current_speed)
                except: pass

            response = web_page()
            # ì•ˆì •ì ì¸ ì „ì†¡ì„ ìœ„í•œ í—¤ë” ì„¤ì •
            conn.send('HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nContent-Length: ' + str(len(response.encode('utf-8'))) + '\r\nConnection: close\r\n\r\n')
            conn.sendall(response.encode('utf-8'))
            time.sleep(0.1)
            conn.close()
        except OSError: pass
    except Exception as e: print("Error:", e)
    gc.collect()
