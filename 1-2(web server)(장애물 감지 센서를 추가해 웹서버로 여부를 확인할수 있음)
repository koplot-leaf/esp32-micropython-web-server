import network, machine, socket, gc, time
from machine import Pin, PWM

# --- 1. Wi-Fi ë° í•˜ë“œì›¨ì–´ ì´ˆê¸°í™” ---
SSID, PASSWORD = 'IOT', '12345678'                           

def connect_wifi():
    w = network.WLAN(network.STA_IF)
    w.active(True)
    w.connect(SSID, PASSWORD)
    while not w.isconnected(): time.sleep(0.1)
    return w.ifconfig()[0]

relay = Pin(16, Pin.OUT); relay.value(0)
fan_ina = PWM(Pin(14), freq=1000); fan_ina.duty(0)
fan_inb = Pin(27, Pin.OUT); fan_inb.value(0)
sensor = Pin(13, Pin.IN) # ì¥ì• ë¬¼ ì„¼ì„œ

fan_running = False
current_speed = 750

def control_fan(state, speed):
    global fan_running
    relay.value(1 if state else 0)
    if state:
        fan_inb.value(0)
        fan_ina.duty(speed)
        fan_running = True
    else:
        fan_ina.duty(0)
        fan_running = False

# --- 3. ì„¹ì…˜ ë¶„ë¦¬í˜• ì›¹ í˜ì´ì§€ (UI/UX ê°œì„ ) ---
def web_page():
    is_occ = (sensor.value() == 0)
    
    # íŒ¬ ìƒíƒœì— ë”°ë¥¸ ë²„íŠ¼ ìƒ‰ìƒ ê²°ì •
    on_style = "background:#2c3e50; color:white;" if fan_running else "background:#eee; color:#aaa;"
    off_style = "background:#e74c3c; color:white;" if not fan_running else "background:#eee; color:#aaa;"
    
    # í™”ì¥ì‹¤ ìƒíƒœì— ë”°ë¥¸ êµ¬ì—­ ìƒ‰ìƒ ê²°ì •
    occ_text = "ì‚¬ìš© ì¤‘ (OCCUPIED)" if is_occ else "ë¹„ì–´ ìˆìŒ (VACANT)"
    occ_bg = "#fff5f5" if is_occ else "#f5fff5"
    occ_border = "#ff4757" if is_occ else "#2ed573"

    return f"""<!DOCTYPE html><html><head><meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width,initial-scale=1'>
    <meta http-equiv='refresh' content='3'>
    <style>
        body {{ font-family:sans-serif; background:#f0f2f5; display:flex; flex-direction:column; align-items:center; padding:20px; }}
        .section {{ background:white; width:90%; max-width:350px; padding:25px; border-radius:20px; margin-bottom:20px; box-shadow:0 5px 15px rgba(0,0,0,0.05); }}
        h2 {{ font-size:16px; color:#555; margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px; }}
        .status-box {{ padding:20px; border-radius:15px; background:{occ_bg}; border:2px solid {occ_border}; color:{occ_border}; font-weight:bold; font-size:18px; }}
        .speed-val {{ font-size:45px; font-weight:200; margin:10px 0; }}
        .btn-group {{ display:flex; gap:10px; margin-top:15px; }}
        .btn {{ flex:1; padding:15px; border:none; border-radius:12px; cursor:pointer; font-weight:bold; transition:0.3s; }}
        input {{ width:100%; margin-top:15px; }}
    </style></head><body>

    <div class='section'>
        <h2>ğŸš½ í™”ì¥ì‹¤ ìƒíƒœ</h2>
        <div class='status-box'>{occ_text}</div>
    </div>

    <div class='section'>
        <h2>ğŸŒ€ í™˜í’ê¸° ì œì–´</h2>
        <div class='speed-val'>{current_speed if fan_running else 0}</div>
        <form action='./'>
            <div class='btn-group'>
                <button name='p' value='1' class='btn' style='{on_style}'>ì¼œì§ (ON)</button>
                <button name='p' value='0' class='btn' style='{off_style}'>êº¼ì§ (OFF)</button>
            </div>
            <input type='range' name='s' min='450' max='1023' value='{current_speed}' onchange='this.form.submit()'>
        </form>
    </div>

    <p style='color:#bbb; font-size:10px;'>2ì´ˆë§ˆë‹¤ ìƒíƒœê°€ ê°±ì‹ ë©ë‹ˆë‹¤.</p>
    </body></html>"""

# --- 4. ì„œë²„ ì‹¤í–‰ (í¬íŠ¸ ì˜¤ë¥˜ ë°©ì§€ í¬í•¨) ---
ip = connect_wifi()
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) # bind ì˜¤ë¥˜ ë°©ì§€
s.bind(('', 80))
s.listen(1)

print("Server is live at:", ip)

while True:
    try:
        conn, addr = s.accept()
        req = conn.recv(1024).decode()
        
        if 'p=1' in req: control_fan(True, current_speed)
        elif 'p=0' in req: control_fan(False, 0)
        
        if 's=' in req:
            try:
                start = req.find('s=') + 2
                end = req.find(' ', start)
                current_speed = int(req[start:end])
                if fan_running: control_fan(True, current_speed)
            except: pass

        conn.send('HTTP/1.1 200 OK\nContent-Type: text/html\nConnection: close\n\n')
        conn.sendall(web_page())
        conn.close()
    except:
        if 'conn' in locals(): conn.close()
    gc.collect()
